{{ $font := .Site.Language.Params.font }}
{{ $lang := .Site.Language.Lang }}

{{ if $font }}
<style>
  /* 正文字体（中文/日文） */
  @font-face {
    font-family: '{{ $font }}';
    src: url('{{ (resources.Get (printf "font/%s.ttf" $font)).RelPermalink }}') format('truetype');
  }

  /* 英文专用字体 */
  @font-face {
    font-family: 'Ubuntu';
    src: url('{{ (resources.Get "font/Ubuntu-R.ttf").RelPermalink }}') format('truetype');
  }

  /* JetBrains Mono 代码字体 */
  @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap');

  :root {
    --base-font-family: '{{ $font }}', sans-serif;       /* 正文字体随语言切换 */
    --english-font-family: 'Ubuntu', sans-serif;        /* 中文界面中的英文字体 */
    --code-font-family: 'JetBrains Mono', monospace;   /* 代码块字体 */
  }

  /* 正文字体应用 */
  body {
    font-family: var(--base-font-family);
  }

  /* 中文页面内英文使用英文字体 */
  body :lang(en) {
    font-family: var(--english-font-family);
  }

  /* 代码块字体固定为 JetBrains Mono */
  code, pre, pre code, .chroma code, .highlight code {
    font-family: var(--code-font-family) !important;
  }

  .highlight {
        /* 你可以根据需要调整这个高度 */
        max-height: 400px;
        overflow: hidden;
    }

    .code-show {
        max-height: none !important;
    }

    .code-more-box {
        width: 100%;
        padding-top: 78px;
        background-image: -webkit-gradient(linear, left top, left bottom, from(rgba(255, 255, 255, 0)), to(#fff));
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 1;
    }

    .code-more-btn {
        display: block;
        margin: auto;
        width: 44px;
        height: 22px;
        background: #f0f0f5;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
        padding-top: 6px;
        cursor: pointer;
    }

    .code-more-img {
        cursor: pointer !important;
        display: block;
        margin: auto;
        width: 22px;
        height: 16px;
    }

    
  /* 返回顶部按钮样式 */
  #backTopBtn {
    display: none;
    position: fixed;
    bottom: 50px; /* 调整距离底部更高 */
    right: 30px;
    z-index: 999;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 6px 10px;
    background: rgba(240,240,245,0.9);
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    font-size: 14px;
    color: #333;
  }

  #backTopBtn img {
    width: 24px;
    height: 24px;
  }

  #TableOfContents > ul, ol {
        ul, ol {
            display: none;
        }
        .open {
            display: block;
        }
    }
</style>

<script>
  function initCodeMoreBox() {
    let codeBlocks = document.querySelectorAll(".highlight");
    if (!codeBlocks) {
      return;
    }
    codeBlocks.forEach(codeBlock => {
      // 校验是否overflow
      if (codeBlock.scrollHeight <= codeBlock.clientHeight) {
        return;
      }
      // 元素初始化
      // codeMoreBox
      let codeMoreBox = document.createElement('div');
      codeMoreBox.classList.add('code-more-box');
      // codeMoreBtn
      let codeMoreBtn = document.createElement('span');
      codeMoreBtn.classList.add('code-more-btn');
      codeMoreBtn.addEventListener('click', () => {
        codeBlock.classList.add('code-show');
        codeMoreBox.style.display = 'none';
        // 触发resize事件，重新计算目录位置
        window.dispatchEvent(new Event('resize'))
      })
      // img
      let img = document.createElement('img');
      img.classList.add('code-more-img');
      img.src = {{ (resources.Get "icons/codeMore.png").Permalink }}
      // 元素添加
      codeMoreBtn.appendChild(img);
      codeMoreBox.appendChild(codeMoreBtn);
      codeBlock.appendChild(codeMoreBox)
    })
  }
  
  initCodeMoreBox();

function initScrollTop() {
  let rightSideBar = document.querySelector(".right-sidebar") || document.body;

  // 创建按钮
  let btn = document.createElement("div");
  btn.id = "backTopBtn";

  // 多语言文字
  let text = "";
  const lang = "{{ .Site.Language.Lang }}";
  if(lang === "en") text = "Back to Top";
  else if(lang === "zh-cn") text = "返回首页";
  else if(lang === "ja") text = "トップに戻る";
  else text = "Back to Top";

  // 图标
  let icon = document.createElement("img");
  icon.src = "{{ (resources.Get "icons/backTop.svg").RelPermalink }}";
  btn.appendChild(icon);

  // 文字
  let span = document.createElement("span");
  span.textContent = text;
  btn.appendChild(span);

  // 点击滚动回顶部
  btn.onclick = function() {
    window.scrollTo({ top: 0, behavior: "smooth" });
  }

  rightSideBar.appendChild(btn);

  // 定义一个函数，统一判断显示或隐藏
  function toggleBtn() {
    if(document.body.scrollTop > 200 || document.documentElement.scrollTop > 200){
      btn.style.display = "flex";
    } else {
      btn.style.display = "none";
    }
  }

  // 初始化一次
  toggleBtn();

  // 监听滚动
  window.addEventListener("scroll", toggleBtn);
}

document.addEventListener("DOMContentLoaded", initScrollTop);

function initTocHide() {
        // 判断是否存在文章目录
        let toc = document.querySelector(".widget--toc");
        if (!toc) {
            return;
        }
        // 监听滚动
        window.addEventListener('scroll', function() {
            //清除class值
            let openUl = document.querySelectorAll(".open");
            if (openUl.length > 0) {
              openUl.forEach((ul) => {
                ul.classList.remove("open")
              })
            }
            // 获取active-class
            let currentLi = document.querySelector(".active-class");
            if (!currentLi) {
                return
            }
            // 展示子ul
            if (currentLi.children.length > 1) {
                currentLi.children[1].classList.add("open")
            }
            // 展示父ul
            let ul = currentLi.parentElement;
            do {
                ul.classList.add("open");
                ul = ul.parentElement.parentElement
            } while (ul !== undefined && (ul.localName === 'ul' || ul.localName === 'ol'))
        });
    }
    initTocHide()
</script>
{{ end }}
